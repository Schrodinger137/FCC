{% extends 'adminBase.html' %}
{% load static %}

{% block title %}Administración de Personajes{% endblock %}

{% block sidebar %}
<hr>
<li class="nav-item"><a class="nav-link" data-bs-toggle="modal" data-bs-target="#createCharacterModal"><i
      class="bi bi-plus"></i>Añadir Personaje</a></li>
<hr>
{% endblock %}

{% block content %}
<div class="container mt-5 pt-4">
  <div class="row">
    <h4>Buscar Personajes</h4>
    <form class="d-flex" role="search">
        <input class="form-control me-2" type="search" placeholder="Search" aria-label="Search" />
        <button class="btn btn-outline-light" type="submit">Search</button>
    </form>
    <br>

    <div class="col-md-12">
      <h4>Lista de Personajes</h4>
      <table class="table table-dark table-bordered table-hover table-striped text-center">
        <thead>
          <tr>
            <th scope="col">Id</th>
            <th scope="col">Nombre</th>
            <th scope="col">Descripción</th>
            <th scope="col">Foto</th>
            <th scope="col">Jugadores Asociados</th>
            <th scope="col">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for personaje in personajes %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td>{{ personaje.nombre }}</td>
            <td>{{ personaje.descripcion }}</td>
            <td>
              <img src="{{ personaje.imagen }}" alt="{{ personaje.nombre }}" class="img-fluid rounded"
                style="max-width: 80px; max-height: 80px; object-fit: cover;">
            </td>
            <td>{{ personaje.jugadores_asociados }}</td>
            <td>
              <button class="btn btn-warning btn-sm">Editar</button>
              <button class="btn btn-danger btn-sm">Eliminar</button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const form = document.querySelector("#createCharacterForm");
    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const formData = new FormData(form);

      try {
        const response = await fetch("{% url 'create_character' %}", {
          method: "POST",
          body: formData
        });

        const data = await response.json();

        if (response.ok) {
          alert(data.mensaje);

          const tbody = document.querySelector("#personajes-table-body");
          const newRow = document.createElement("tr");
          newRow.innerHTML = `
          <td>${tbody.children.length + 1}</td>
          <td>${formData.get("nombre")}</td>
          <td>${formData.get("descripcion")}</td>
          <td><img src="${data.imagen_url}" style="width:50px;height:50px;object-fit:cover;border-radius:5px;"></td>
          <td>0</td>
          <td>
            <button class="btn btn-warning btn-sm">Editar</button>
            <button class="btn btn-danger btn-sm">Eliminar</button>
          </td>
        `;
          tbody.appendChild(newRow);
          form.reset();
        } else {
          alert(data.error);
          console.log(data.error);
        }
      } catch (err) {
        alert("Error al enviar el formulario: " + err);
        console.log("Error al enviar el formulario: " + err);
      }
    });
  });
</script>
{% endblock %}